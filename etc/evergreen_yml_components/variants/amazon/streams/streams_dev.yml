# Amazon build variants for testing streams in development environments
#
# After the branching variants in this file
# should NOT run on a new rapid release (v7.1, v7.2 etc.)
# and LTS release (v7.0, v6.0 etc.) branch projects

buildvariants:
  - name: enterprise-amazon2023-streams
    display_name: "Amazon Linux 2023 enterprise streams"
    modules: ["asp-js-engine"]
    run_on:
      - amazon2023-latest-small
    expansions:
      test_flags: >-
        --excludeWithAnyTags=SERVER-34286,incompatible_with_amazon_linux,requires_external_data_source,requires_ldap_pool
        --additionalFeatureFlags=featureFlagStreams
      bazel_compile_flags: >-
        --define=MONGO_DISTMOD=amazon2023
        --streams_release_build=True
      multiversion_platform: amazon2023
      multiversion_edition: enterprise-streams
      compile_variant: enterprise-amazon2023-streams
      large_distro_name: amazon2023.3-c5-24xlarge
    tasks:
      - name: compile_and_archive_dist_test_TG
        distros:
          - amazon2023.3-c5-24xlarge
      - name: aggregation
      - name: .streams_release_test
      - name: generate_buildid_to_debug_symbols_mapping

  - name: enterprise-amazon2023-streams-arm64
    display_name: "Amazon Linux 2023 enterprise streams arm64"
    modules: ["asp-js-engine"]
    run_on:
      - amazon2023-arm64-latest-m8g-xlarge
    expansions:
      test_flags: >-
        --excludeWithAnyTags=SERVER-34286,incompatible_with_amazon_linux,requires_external_data_source,requires_ldap_pool
        --additionalFeatureFlags=featureFlagStreams
      bazel_compile_flags: >-
        --define=MONGO_DISTMOD=amazon2023
        --streams_release_build=True
      multiversion_platform: amazon2023
      multiversion_edition: enterprise-streams
      compile_variant: enterprise-amazon2023-streams-arm64
      large_distro_name: amazon2023.3-arm64-xxxlarge
    tasks:
      - name: compile_and_archive_dist_test_TG
        distros:
          - amazon2023.3-arm64-xxxlarge
      - name: aggregation
      - name: .streams_release_test
      - name: generate_buildid_to_debug_symbols_mapping

  - name: enterprise-amazon2023-streams-tsan
    display_name: "TSAN Amazon Linux 2023 arm64 enterprise streams"
    modules: ["asp-js-engine"]
    run_on:
      - amazon2023-arm64-latest-m8g-xlarge
    stepback: false
    expansions:
      test_flags: >-
        --excludeWithAnyTags=tsan_incompatible
        --additionalFeatureFlags=featureFlagStreams
      lang_environment: LANG=C
      san_options: TSAN_OPTIONS="abort_on_error=1:disable_coredump=0:handle_abort=1:halt_on_error=1:report_thread_leaks=0:die_after_fork=0:history_size=4:suppressions=etc/tsan.suppressions:external_symbolizer_path=/opt/mongodbtoolchain/v5/bin/llvm-symbolizer"
      bazel_compile_flags: >-
        --config=dbg_tsan
        --define=MONGO_DISTMOD=amazon2023
        --opt=on
        --fission=no
        --streams_release_build=True
        --jobs=800
      resmoke_jobs_factor: 0.3
      multiversion_platform: amazon2023
      multiversion_edition: enterprise
      compile_variant: enterprise-amazon2023-streams-tsan
      large_distro_name: amazon2023-arm64-latest-m8g-8xlarge
      xlarge_distro_name: amazon2023-arm64-latest-m8g-16xlarge
    tasks:
      - name: compile_and_archive_dist_test_TG
        distros:
          - amazon2023-arm64-latest-m8g-8xlarge
      - name: .streams_release_test
      - name: generate_buildid_to_debug_symbols_mapping

  - name: enterprise-amazon2023-streams-aubsan
    display_name: "{A,UB}SAN Amazon Linux 2023 arm64 enterprise streams"
    modules: ["asp-js-engine"]
    run_on:
      - amazon2023-arm64-latest-m8g-xlarge
    stepback: false
    expansions:
      test_flags: >-
        --excludeWithAnyTags=incompatible_aubsan
        --additionalFeatureFlags=featureFlagStreams
      lang_environment: LANG=C
      san_options: >-
        UBSAN_OPTIONS="print_stacktrace=1:external_symbolizer_path=/opt/mongodbtoolchain/v5/bin/llvm-symbolizer"
        LSAN_OPTIONS="suppressions=etc/lsan.suppressions:report_objects=1"
        ASAN_OPTIONS="detect_leaks=1:check_initialization_order=true:strict_init_order=true:abort_on_error=1:disable_coredump=0:handle_abort=1:strict_string_checks=true:detect_invalid_pointer_pairs=1:external_symbolizer_path=/opt/mongodbtoolchain/v5/bin/llvm-symbolizer"
      bazel_compile_flags: >-
        --config=dbg_aubsan
        --define=MONGO_DISTMOD=amazon2023
        --opt=on
        --fission=no
        --streams_release_build=True
      resmoke_jobs_factor: 0.3
      hang_analyzer_dump_core: false
      multiversion_platform: amazon2023
      multiversion_edition: enterprise
      compile_variant: enterprise-amazon2023-streams-aubsan
      large_distro_name: amazon2023-arm64-latest-m8g-8xlarge
      xlarge_distro_name: amazon2023-arm64-latest-m8g-16xlarge
    tasks:
      - name: compile_and_archive_dist_test_TG
        distros:
          - amazon2023-arm64-latest-m8g-8xlarge
      - name: .streams_release_test
      - name: generate_buildid_to_debug_symbols_mapping
